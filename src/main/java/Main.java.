import database.DatabaseConfig;
import model.Student;
import model.Inventory;
import service.StudentService;
import service.InventoryService;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

public class Main {
    public static void main(String[] args) {
        StudentService studentService = new StudentService();
        InventoryService inventoryService = new InventoryService();
        Connection conn = null;

        try {
            // 1. Establish Master Connection
            conn = DatabaseConfig.getConnection();
            
            // 2. Start Level 2 Transaction
            DatabaseConfig.startTransaction(conn);
            System.out.println("--- Starting Final Transactional Test ---");

            // 3. Perform Data Entry Operations
            studentService.registerStudent(conn, new Student(0, "Alice Brown", "alice@example.com", "Computer Science"));
            inventoryService.addItem(conn, new Inventory(0, "Laptop", 3, 1200.50));
            inventoryService.addItem(conn, new Inventory(0, "Mechanical Keyboard", 10, 85.00));

            // 4. Commit all changes if successful
            DatabaseConfig.commitTransaction(conn);
            System.out.println("✅ Transaction Success: All data saved securely!");

            // 5. Level 3: Business Intelligence Reporting
            System.out.println("\n--- Level 3: Inventory Analytics Report ---");
            inventoryService.generateFullReport(conn);

            // 6. Level 3: Targeted Search
            System.out.println("\n--- Level 3: Student Search (Course: Computer Science) ---");
            List<Student> csStudents = studentService.getStudentsByCourse(conn, "Computer Science");
            if (csStudents.isEmpty()) {
                System.out.println("No students found in this course.");
            } else {
                csStudents.forEach(s -> System.out.println("Found Student: " + s.getName() + " (" + s.getEmail() + ")"));
            }

        } catch (SQLException e) {
            // 7. Rollback if ANY step fails
            try {
                if (conn != null) {
                    DatabaseConfig.rollbackTransaction(conn);
                    System.err.println("❌ Transaction Failed. Database rolled back to previous state.");
                }
            } catch (SQLException ex) { ex.printStackTrace(); }
            System.err.println("Error details: " + e.getMessage());
        } finally {
            // 8. Close resources
            try { if (conn != null) conn.close(); } catch (SQLException e) { e.printStackTrace(); }
        }
    }
}
